<!DOCTYPE html>
<html>
<head>
    <title>Admin Panel</title>
    <link rel="stylesheet" href="/New-Church-Census-Test/styles.css">
    <!-- Firebase Scripts FIRST -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="/New-Church-Census-Test/firebase-config.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="admin-container">
        <h1>User Management</h1>
        <button class="btn" onclick="createUser()">Create New User</button>
        <div id="userList"></div>
    </div>

    <script>

        firebase.auth().onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            try {
                const isAdmin = await checkAdmin(user.uid);
                if (!isAdmin) window.location.href = 'main.html';
                loadUsers();
            } catch (error) {
                console.error("Admin check failed:", error);
            }
        });

        async function checkAdmin(uid) {
            const snapshot = await firebase.database().ref(`admins/${uid}`).once('value');
            return snapshot.exists();
        }

		// Modified loadUsers function
		async function loadUsers() {
			try {
				// Get list of users from your own database node
				const snapshot = await firebase.database().ref('users').once('value');
				const users = snapshot.val() || {};
				
				let html = `<table class="data-table">
					<tr><th>Email</th><th>Role</th><th>Action</th></tr>`;
				
				for (const uid in users) {
					const isAdmin = await checkAdmin(uid);
					html += `<tr>
						<td>${users[uid].email}</td>
						<td>${isAdmin ? 'Admin' : 'User'}</td>
						<td><button onclick="deleteUser('${uid}')">Delete</button></td>
					</tr>`;
				}
				
				document.getElementById('userList').innerHTML = html + '</table>';
			} catch (error) {
				console.error("Failed to load users:", error);
			}
		}

		// Custom Modal Logic
		let modalResolve;

		function showModal(message, isPrompt = true) {
			const modal = document.getElementById('customModal');
			const input = document.getElementById('modalInput');
			
			document.getElementById('modalMessage').textContent = message;
			input.style.display = isPrompt ? 'block' : 'none';
			modal.style.display = 'block';
			
			if (isPrompt) input.value = '';
			
			return new Promise((resolve) => {
				modalResolve = resolve;
			});
		}

		// Modal Event Listeners
		document.querySelector('.close').addEventListener('click', () => {
			document.getElementById('customModal').style.display = 'none';
			modalResolve(null);
		});

		document.getElementById('modalConfirm').addEventListener('click', () => {
			const input = document.getElementById('modalInput');
			const value = input.style.display === 'none' ? true : input.value;
			document.getElementById('customModal').style.display = 'none';
			modalResolve(value);
		});

		document.getElementById('modalCancel').addEventListener('click', () => {
			document.getElementById('customModal').style.display = 'none';
			modalResolve(null);
		});

		// Modified createUser function
		async function createUser() {
			const email = await showModal("Enter email:");
			if (!email) return;
			
			const password = await showModal("Enter password:");
			if (!password) return;

			const isAdmin = await showModal("Make admin? (yes/no)", false);
			
			try {
				const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
				const uid = userCredential.user.uid;
				
				await firebase.database().ref(`users/${uid}`).set({
					email: email,
					created: Date.now()
				});
				
				if (isAdmin) {
					await firebase.database().ref(`admins/${uid}`).set(true);
				}
				loadUsers();
			} catch (error) {
				alert(error.message);
			}
		}

		// Modified deleteUser function
		async function deleteUser(uid) {
			const confirm = await showModal("Delete this user permanently?", false);
			if (!confirm) return;
			
			try {
				await firebase.auth().deleteUser(uid);
				await firebase.database().ref(`admins/${uid}`).remove();
				await firebase.database().ref(`users/${uid}`).remove();
				loadUsers();
			} catch (error) {
				alert("Deletion failed: " + error.message);
			}
		}
				
    </script>
	
	<div id="customModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <p id="modalMessage"></p>
        <input type="text" id="modalInput" class="modal-input" style="display: none;">
        <div class="modal-buttons">
            <button class="btn" id="modalConfirm">OK</button>
            <button class="btn" id="modalCancel">Cancel</button>
        </div>
    </div>
	</div>
	
</body>
</html>